name: HyperOS Port Build

on:
  workflow_dispatch:
    inputs:
      stock_url:
        description: 'Stock ROM Download Link'
        required: true
      port_url:
        description: 'Port ROM Download Link'
        required: true
      pack_type:
        description: 'Output format (super/payload)'
        required: true
        default: 'super'
      gms_phonesky_url:
        description: 'Phonesky ZIP Download Link (Optional)'
        required: false
        default: 'https://pixeldrain.com/api/file/6izRe9gs'
      gms_velvet_url:
        description: 'Velvet ZIP Download Link (Optional)'
        required: false
        default: 'https://pixeldrain.com/api/file/HniGcyuV'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd aria2
          pip install -r requirements.txt || pip install requests glob2

      - name: Prepare Binaries
        run: |
          chmod +x bin/linux/x86_64/*

      - name: Download ROMs
        run: |
          mkdir -p downloads
          echo "Downloading Stock ROM..."
          aria2c -x 16 -s 16 -d downloads -o stock.zip "${{ github.event.inputs.stock_url }}"
          echo "Downloading Port ROM..."
          aria2c -x 16 -s 16 -d downloads -o port.zip "${{ github.event.inputs.port_url }}"

      - name: Download GMS (Optional)
        run: |
          mkdir -p gapps
          if [ -n "${{ github.event.inputs.gms_phonesky_url }}" ]; then
            echo "Downloading Phonesky ZIP..."
            aria2c -x 16 -s 16 -d gapps -o phonesky.zip "${{ github.event.inputs.gms_phonesky_url }}"
          fi
          if [ -n "${{ github.event.inputs.gms_velvet_url }}" ]; then
            echo "Downloading Velvet ZIP..."
            aria2c -x 16 -s 16 -d gapps -o velvet.zip "${{ github.event.inputs.gms_velvet_url }}"
          fi

      - name: Run Porting Tool
        run: |
          python3 main.py --stock downloads/stock.zip \
                          --port downloads/port.zip \
                          --pack-type "${{ github.event.inputs.pack_type }}" \
                          --clean

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: HyperOS-Port-${{ github.run_id }}
          path: |
            out/*_hybrid/
          compression-level: 9
